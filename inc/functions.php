<?

$langnames = array('de' => 'Deutsch', 'en' => 'English', 'fr' => 'Français',
		'cs' => '&#268;esky', 'pt' => 'Português', 'it' => 'Italiano',
		'es' => 'Español', 'da' => 'Dansk', 'pl' => 'Polski', 
		'hr' => 'Hrvatski', 'ar' =>
		'&#1575;&#1604;&#1593;&#1585;&#1576;&#1610;&#1577;', 'cw' => 
		'CW abbreviations', 'ro'=>'Român&#259;',
		'ja'=>'&#x65e5;&#x672c;&#x8a9e;',
		'sl' => 'Sloven&#353;&#269;ina', 'sv'=>'Svenska', 'nl' =>
		'Nederlands', 'ru' =>
		'&#1056;&#1091;&#1089;&#1089;&#1082;&#1080;&#1081;',
		'bs' => 'Bosanski', 'fi' => 'Suomi', 'gr' =>
		'&#917;&#955;&#955;&#951;&#957;&#953;&#954;&#940;',
		'bz' => 'Português brasileiro',
		'ca' => 'Català', 'hu' => 'Magyar', 'gl' => 'Galego',
		'ms' => 'Bahasa Melayu', 'th' =>
		'&#3616;&#3634;&#3625;&#3634;&#3652;&#3607;&#3618;',
		'tr' => 'Türkçe',
		'zh' => '&#31616;&#20307;&#20013;&#25991;',
		'cn' => '&#32321;&#39636;&#20013;&#25991;',
		'bg' => '&#1041;&#1098;&#1083;&#1075;&#1072;&#1088;&#1089;&#1082;&#1080;',
		'uk' => '&#1059;&#1082;&#1088;&#1072;&#1111;&#1085;&#1089;&#1100;&#1082;&#1072;',
        'br' => 'Português brasileiro', 'no' => 'Norsk', 'sr' => 'Srpski', 'si' => '&#3523;&#3538;&#3458;&#3524;&#3517;',
		'ko' => '한국어', 'id' => 'Bahasa Indonesia',
		'he' => 'עִבְרִית'

);

$enlangnames = array('de' => 'German', 'en' => 'English', 'fr' => 'French',
		'cs' => 'Czech', 'pt' => 'Portuguese', 'it' => 'Italian',
		'es' => 'Spanish', 'da' => 'Danish', 'pl' => 'Polish', 
		'hr' => 'Croatian', 'ar' => 'Arabic', 'cw' => 'Morse Code', 
		'ro'=>'Romanian', 'ja'=>'Japanese',
		'sl' => 'Slovenian', 'sv'=>'Swedish', 'nl' => 'Dutch', 
		'ru' => 'Russian', 'bs' => 'Bosnian', 'fi' => 'Finnish',
		'gr' => 'Greek', 'bz' => 'Brasilian',
		'ca' => 'Catalan', 'hu' => 'Hungarian', 'gl' => 'Galician',
		'ms' => 'Malay', 'th' => 'Thai', 'tr' => 'Turkish',
		'zh' => 'Simplified Chinese', 'cn' => 'Traditional Chinese',
		'bg' => 'Bulgarian', 'uk' => 'Ukrainian', 'br' => 'Brazilian Portuguese', 'no' => 'Norwegian',
        'sr' => 'Serbian', 'si' => 'Sinhala',
		'ko' => 'Korean', 'id' => 'Indonesian',
		'he' => 'Hebrew'
);

$kochchar =
array('K','M','U','R','E','S','N','A','P','T','L','W',
'I','.','J','Z','=','F','O','Y',',','V','G','5','/','Q','9','2',
'H','3','8','B','?','4','7','C','1','D','6','0','X');

$letterschar = array('a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i',
'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v',
'w', 'x', 'y', 'z');

$figureschar = array('1', '2', '3', '4', '5', '6', '7', '8', '9',
'0');

$mixedchar = array('a', 'b', 'c', 'd', 'e', 'f', 'g', 'h', 'i',
'j', 'k', 'l', 'm', 'n', 'o', 'p', 'q', 'r', 's', 't', 'u', 'v',
'w', 'x', 'y', 'z', '1', '2', '3', '4', '5', '6', '7', '8', '9',
'0', '?', '/', '.', ',', '=');

$extrachar = array("!", "quot", "'", "(", ")", "+", "-", ":", ";", "@", "À", "Ä", "Æ", "Å", "Ç", "É", "È", "Ñ", "Ö", "Ø", "Ü" );

$extracharlc = array("à" => "À", "æ" => "Æ", "å" => "Å", "ä" => "Ä", "ç" => "Ç", "é" => "É", "è" => "È", "ñ" => "Ñ", "ö" => "Ö", "ø" => "Ø", "ü" => "Ü");

$cyrillicchar = array("а", "б", "в", "г", "д", "е", "ж", "з", "и", "й", "к", "л", "м", "н", "о",
		            "п", "р", "с", "т", "у", "ф", "х", "ц", "ч", "ш", "щ", "ъ", "ы", "ь", "э", "ю", "я", "ѐ", "ё", "ђ",
						            "ѓ", "є", "ѕ", "і", "ї", "ј", "љ", "њ", "ћ", "ќ", "ѝ", "ў", "џ");

$arabicchar = array(
 "ا","ب","ت","ث","ج","ح","خ","د","ذ","ر","ز","س","ش","ص","ض","ط","ظ","ع","غ","ف","ق","ك","ل","م","ن","و","ء","لا","ﻕ","ي","ه"
 );


$morsecode = array (
" " => " ", "!" => "..--.", "\"" => ".-..-.", "$" => "...-..-", "&" => ". ...", "'" => ".----.", "(" => "-.--.", ")" => "-.--.-", "+" => ".-.-.", "," => "--..--", "-" => "-....-", "." => ".-.-.-", "/" => "-..-.", "0" => "-----", "1" => ".----", "2" => "..---", "3" => "...--", "4" => "....-", "5" => ".....", "6" => "-....", "7" => "--...", "8" => "---..", "9" => "----.", ":" => "---...", ";" => "-.-.-.", "=" => "-...-", "?" => "..--..", "@" => ".--.-.", "A" => ".-", "B" => "-...", "C" => "-.-.", "D" => "-..", "E" => ".", "F" => "..-.", "G" => "--.", "H" => "....", "I" => "..", "J" => ".---", "K" => "-.-", "L" => ".-..", "M" => "--", "N" => "-.", "O" => "---", "P" => ".--.", "Q" => "--.-", "R" => ".-.", "S" => "...", "T" => "-", "U" => "..-", "V" => "...-", "W" => ".--", "X" => "-..-", "Y" => "-.--", "Z" => "--..", "\\" => "-..-.", "`" => ".----.", "a" => ".-", "b" => "-...", "c" => "-.-.", "d" => "-..", "e" => ".", "f" => "..-.", "g" => "--.", "h" => "....", "i" => "..", "j" => ".---", "k" => "-.-", "l" => ".-..", "m" => "--", "n" => "-.", "o" => "---", "p" => ".--.", "q" => "--.-", "r" => ".-.", "s" => "...", "t" => "-", "u" => "..-", "v" => "...-", "w" => ".--", "x" => "-..-", "y" => "-.--", "z" => "--..", "«" => ".-..-.", "»" => ".-..-.", "À" => ".--.-", "Á" => ".--.-", "Â" => ".-", "Ã" => ".-", "Ä" => ".-.-", "Å" => ".--.-", "Æ" => ".- .", "Ç" => "-.-..", "È" => "..-..", "É" => "..-..", "Ê" => ".", "Ë" => ".", "Ì" => "..", "Í" => "..", "Î" => "..", "Ï" => "..", "Ð" => "..--.", "Ñ" => "--.--", "Ò" => "---", "Ó" => "---", "Ô" => "---", "Õ" => "---", "Ö" => "---.", "Ø" => "---.", "Ù" => "..-", "Ú" => "..-", "Û" => "..-", "Ü" => "..--", "Ý" => "-.--", "Þ" => ".--..", "ß" => "...--..", "à" => ".--.-", "á" => ".--.-", "â" => ".-", "ã" => ".-", "ä" => ".-.-", "å" => ".--.-", "æ" => ".- .", "ç" => "-.-..", "è" => "..-..", "é" => "..-..", "ê" => ".", "ë" => ".", "ì" => "..", "í" => "..", "î" => "..", "ï" => "..", "ð" => "..--.", "ñ" => "--.--", "ò" => "---", "ó" => "---", "ô" => "---", "õ" => "---", "ö" => "---.", "ø" => "---.", "ù" => "..-", "ú" => "..-", "û" => "..-", "ü" => "..--", "ý" => "-.--", "þ" => ".--..", "ÿ" => "-.--", 
);




function uid2info ($uid) {
global $db;
    $getcall = mysqli_query($db,"SELECT `username`, `name` from
	lcwo_users where `ID`='$uid';");

    if (!$getcall) {
        return "unknown";
    }

    return mysqli_fetch_object($getcall);
}


function uid2uname ($uid) {
global $db;
    $getuname = mysqli_query($db,"SELECT `username`  from
	lcwo_users where `ID`='$uid';");

    if (!$getuname) {
        return "unknown";
    }

    $xx = mysqli_fetch_object($getuname);

	return $xx->username;
}

function uname2uid ($u) {
global $db;

	if (!preg_match('/^[a-zA-Z0-9]+$/', $u)) {
		return 0;
	}

    $query = mysqli_query($db,"SELECT `id`  from
	lcwo_users where `username`='$u';");

    if (!$query) {
        return "0";
    }

    $o = mysqli_fetch_object($query);

	return $o->id;
}


function getgroups ($speed, $eff, $lesson, $kochchar, $minutes, $randlength, $realchar) {
	global $db;

    error_log(print_r($kochchar,1));

	/* Not nice, but I changed things. outside, randomlength=0
	* now means, random between 2 and 7. Any other value means
	* fixed groups of this length */
	
	if ($randlength == 0) {
		$randlength = 1;
		$len = weightedrand1(); 
	}
	else {
		$len = $randlength;
		$randlength = 0;
	}
		
	$ret = '';

	/* Do we request Koch groups? If so, weighting will be used
	 * in the randomness of characters */

	if ($kochchar[0] == 'K' and $kochchar[1] == 'M') {
			$weight = 1;
	}
	else {
			$weight = 0;
	}

	#
	# Actual production of the groups.
	# We initially produce more groups than needed and then
	# cut them to get as close as possible to $minutes
	#

	$grp = array();

	$c=0;
	$tmp = '';
	for ($n=1; $n <= ($minutes*5*$eff*2); $n++) {
		if ($weight) {
			$tmp .= $kochchar[weightedrand2($lesson)];
		}
		else {
			$tmp .= $kochchar[intval(rand(0, $lesson))];
		}
		$c++;
		if (!($c % $len)) {
				if ($randlength) {
					$len = weightedrand1(); 
				}
				array_push($grp, $tmp);
				$tmp = '';
				$c=0;
				if ($_SESSION['cw_tone_random']) {
					$tmp = "|f".(intval(rand(500,900)))." ";
				}
		}
	}

	$ret = implode(' ', $grp);
	$grpcnt = count($grp);

    # make sure there are at least 5 occurences of the new letter in the lesson
#    if ($weight) {
#        $ret = ensure_char($ret, $kochchar[$lesson]);
#        $grp = explode(' ', $ret);
#    }


    # for code groups we may want "real" characters, so x wpm will mean
    # that we generate x groups, no matter how long it takes to send them
    # in PARIS speed
    if ($realchar) {
        $ret = implode(' ', array_slice($grp, 0, $eff*$minutes));
    }
    else {
        # Calculate actual length ($rs[2]) and then cut accordingly
        $rs = realspeed($ret, $speed, $eff);

        # New number of groups: 
        # floor or ceil of ($grpcnt * $minutes*60 / $rs[2])
        # whichever is closer to 60 seconds
        
        $grpcnt1 = floor($grpcnt * $minutes*60 / $rs[2]); 
        $grpcnt2 = ceil($grpcnt * $minutes*60 / $rs[2]); 

        $ret1 = implode(' ', array_slice($grp, 0, $grpcnt1));
        $ret2 = implode(' ', array_slice($grp, 0, $grpcnt2));

        $rs1 = realspeed($ret1, $speed, $eff);
        $rs2 = realspeed($ret2, $speed, $eff);

        if (abs(60-$rs1[2]) < abs(60-$rs2[2])) {
                $ret = $ret1;
        }
        else {
                $ret = $ret2;
        }
    }

    if ($_SESSION['player'] != PL_JSCWLIB) {
        if ($_SESSION['vvv'] == 1) {
            $ret = "VVV = ".$ret." <AR>";
        }
    }
    
	return $ret;
}

# we ensure that the char $letter is in $text
# since we over-produce groups by the factor of more than
# two, # here we only operate on the lower third of the groups
# generated. in there we want to have at least one times
# the new character, but with additional length a few more
# are required.

function ensure_char ($text, $letter) {

    $min_char = ceil(mb_strlen($text)/3/6/10) + 1;  
    $log = "******GOAL for $letter is $min_char *****************************\n";
    $round = 0;

    # correct max. 20 rounds.
    for ($i = 0; $i < 20; $i++) { 
        $counts = count_chars(mb_substr($text, 0, mb_strlen($text)/3), 0);
        $log .= "$i - $letter exists ".$counts[ord($letter)]." times: $text\n";

        if ($counts[ord($letter)] > $min_char) {
            $log .= "GOAL REACHED\n";
            break;
        }

        # replace random non-space character with $letter
        $pos = random_int(0, mb_strlen($text)/3);
        if ($text[$pos] != " ") {
            $text[$pos] = $letter;
            $log .= "REPLACED $letter at $pos (round $i)\n";
        }
    }

#    $fh = fopen('ensure.txt','a');
#    if ($fh) {
#       fputs($fh, $log);
#       fclose($fh);
#    }

    return $text;
}




function geterror ($g1, $g2) {
	if ($g1 == $g2) {
		return 0;
	}
	else {
		$err = 0;
		for ($x = 0; $x < mb_strlen($g1); $x++) {
			if (mb_substr($g1, $x, 1) != mb_substr($g2, $x, 1)) {
				$err++;
			}
		}
		return $err;
	}
}

# First span has incorrect chars, second span has only dashes.
function merge_error_spans($sp1, $sp2) {
	$l1 = mb_strlen($sp1);
	$l2 = mb_strlen($sp2);
	$mspan = '';
	if ($l1 > $l2) {
		$mspan = $sp1;
	} else {
		$mspan = $sp1 . mb_substr($sp2, $l1, $l2 - $l1);
	}
	$err = mb_strlen($mspan);
	$result = '';
	for ($i = 0; $i < mb_strlen($mspan); $i++) {
		$c = mb_substr($mspan, $i, 1);
		if ($c == '^') {
            $c = '-';
			$result .= colorspan($c, 'blue');
		} else {
			$result .= colorspan($c, 'red');
		}
	}
	return array($result, $err);
}

# This function calculates the number of missed characters in the original strings.
# Any extra characters in the user's input are not considered mistakes.
function check ($w1, $w2) {		#w1 = original; w2 with errors
	$ret = '';
	$err = 0;

	$l1 = mb_strlen($w1);
	$l2 = mb_strlen($w2);
	$a = array_fill(0, $l1 + 1, array_fill(0, $l2 + 1, 0));
	$a[0][0] = 0;
	for ($i = 1; $i <= $l1; $i++) {
		$a[$i][0] = $a[$i - 1][0] + 1;
	}
	for ($j = 1; $j <= $l2; $j++) {
		$a[0][$j] = $a[0][$j - 1] + 1;
	}
	for ($i = 1; $i <= $l1; $i++) {
		for ($j = 1; $j <= $l2; $j++) {
			$a[$i][$j] = $a[$i - 1][$j] + 1;
			if ($a[$i - 1][$j - 1] + 1 < $a[$i][$j]) {
				$a[$i][$j] = $a[$i - 1][$j - 1] + 1;
			}
			if ($a[$i][$j - 1] + 1 < $a[$i][$j]) {
				$a[$i][$j] = $a[$i][$j - 1] + 1;
			}
			if (mb_substr($w1, $i - 1, 1) == mb_substr($w2, $j -1, 1)) {
				if ($a[$i - 1][$j - 1] < $a[$i][$j]) {
					$a[$i][$j] = $a[$i - 1][$j - 1];
				}
			}
		}
	}
	$err = 0;
	$i = $l1;
	$j = $l2;
	$error_span1 = '';
	$error_span2 = '';
	while ($i > 0 || $j > 0) {
		$new_i = $i;
		$new_j = $j;
		$value = '';

		if (($i > 0) && ($j > 0) && (mb_substr($w1, $i - 1, 1) == mb_substr($w2, $j - 1, 1)) && ($a[$i][$j] == $a[$i - 1][$j - 1] )) {
			$error_span = merge_error_spans($error_span1, $error_span2);
			$ret = $error_span[0] . $ret;
			$ret = colorspan(mb_substr($w1, $i - 1, 1), 'green') . $ret;
			$err = $err + $error_span[1];
			$error_span1 = '';
			$error_span2 = '';
			$i = $i - 1;
			$j = $j - 1;
			continue;
		}
		if (($i > 0) && ($j > 0) && ($a[$i - 1][$j - 1] + 1 == $a[$i][$j])) {
			$error_span1 = mb_substr($w1, $i - 1, 1) . $error_span1;
			$error_span2 = '^' . $error_span2;
			$i = $i - 1;
			$j = $j - 1;
			continue;
		}

		if (($j > 0) && ($a[$i][$j - 1] + 1 == $a[$i][$j])) {
			$i = $i;
			$j = $j - 1;
			$error_span2 = '^' . $error_span2;
			continue;
		}
		if (($i > 0) && ($a[$i - 1][$j] + 1 == $a[$i][$j])) {
			$error_span1 = mb_substr($w1, $i - 1, 1) . $error_span1;
			$i = $i - 1;
			$j = $j;
			continue;
		}
	}
	$error_span = merge_error_spans($error_span1, $error_span2);
	$ret = $error_span[0] . $ret;
	$err = $err + $error_span[1];

	return array($ret, $err);
}


function colorspan ($e, $c) {
	if ($c == 'red') {
		return ('<span style="font-family:monospace;color:#aa0000;text-decoration:underline;">'.$e.'</span>');
	}
	else if ($c == 'blue') {
		return ('<span style="font-family:monospace;color:#1111ff;font-style:italic;">'.$e.'</span>');
	}
	else {
		return ('<span style="font-family:monospace;color:#00aa00;">'.$e.'</span>');
	}
}

include("playerfunctions.php");


function da($date) {
	if (mb_strlen($date) == 14) {
		$nd = mb_substr($date, 0, 4).'-';
		$nd .= mb_substr($date, 4, 2).'-';
		$nd .= mb_substr($date, 6, 2).' ';
		$nd .= mb_substr($date, 8, 2).':';
		$nd .= mb_substr($date, 10, 2);
		return $nd;
	}
	else {
		return mb_substr($date, 0, 16);
	}

}

function esc ($str) {
    global $db;
    return mysqli_real_escape_string($db, stripslashes($str));
}

function loadlocale ($locale) {
global $db;
unset ($_SESSION['l']);

if ($locale == 'cw') {
	$locale = 'en';
	$cw = 1;
}
else {
	$cw = 0;
}

# get version of current locale
$gn = mysqli_query($db, "SELECT `val` from lcwo_config where `key`='localeversion'");
$v = mysqli_fetch_object($gn);

unset ($_SESSION['localeversion']);
$_SESSION['localeversion'] = $v->val;


# get all names of texts
$gn = mysqli_query($db, "SELECT distinct `name` from lcwo_texts");
while ($n = mysqli_fetch_object($gn)) {
		$names[$n->name] = 1;
}

# load texts in own locale..
$gt = mysqli_query($db, "SELECT `text`, `name` from `lcwo_texts` where `lang`='$locale'");

while ($t = mysqli_fetch_object($gt)) {
		if ($cw) {
			$_SESSION['l'][$t->name] = text2dotdash($t->text);
		}
		else {
			unset($_SESSION['l'][$t->name]);
			$_SESSION['l'][$t->name] = preg_replace("/wpm/i", "WPM", $t->text);
		}
		unset($names[$t->name]);
}


# load remaining in English...
$gt = mysqli_query($db, "SELECT `text`, `name` from `lcwo_texts` where `lang`='en'");

while ($t = mysqli_fetch_object($gt)) {
		if (isset($names[$t->name])) {
			unset($_SESSION['l'][$t->name]);
			$_SESSION['l'][$t->name] = preg_replace("/wpm/i", "WPM", $t->text);
			unset($names[$t->name]);
		}
}

$_SESSION['loadedlocale'] = 1;

} # loadlocale


# Return string in locale. If second argument = 1, omit JavaScript stuff for
# insite-translation

function l () {
	$na = func_num_args();
	$a = func_get_arg(0);
	$word = $_SESSION['l'][$a];
	
	if ($na == 2 && func_get_arg(1) == '1') {
			$b = 0;	# do not add JavaScript stuff
	}

	# Plural forms, especially important for Slavic languages. 
	#
	# Database string has the following format:
	#
	#   0^WORD_1^WORD_2^WORDDUAL_3-4^WORDPLURAL1_5+^WORDPLURALX 

	if ($na == 3 or preg_match('/_/', $word)) {
            if ($na == 3) {
                $nr = func_get_arg(2);  # requested number
            }
            else {
                    $nr = 0;            # fallback
            }	
			$arr = explode('_', $word);

			if (count($arr) > 1) {
					for ($i = 0; $i < count($arr); $i++) {
							$tmp = explode('^', $arr[$i]);
							$m = array();

							if ($tmp[0] == $nr) {	# Exact match => take it
								$word = $tmp[1];
								break;
							}
							else if (preg_match('/(\d)-(\d)/', $tmp[0], $m) &&
									$m[1] <= $nr && $m[2] >= $nr) {
								$word = $tmp[1];
								break;
							}
							else if (preg_match('/(\d)\+/', $tmp[0], $m) &&
									$m[1] <= $nr) {
								$word = $tmp[1];
								break;
							}
					}
			}
	}

	if (array_key_exists('debug', $_SESSION) && $_SESSION['debug'] == 1) {
		return "($a) ".$word;
	}
	elseif (array_key_exists('debug', $_SESSION) && $_SESSION['debug'] == 3) {
		$t = $word;
		if ($b == 0) {
			$t = preg_replace('/"/', '&quot;', $t);
			$t = preg_replace('/\//', '&#47;', $t);
			$t = preg_replace('/\'/', '\\\'', $t);
			return "<span onMouseover=\"babel('babel_$a', '".$t."', '".$_SESSION['lang']."')\" name='babel_$a' id='babel_$a'>".$word."</span>";
		}
		else {
			return $t."*";
		}
	}
	else {
		return $word;
	}
}


function currentparameters () {

echo "<p>".l('currentparameters').": ".l('charspeedlong')." = <strong>".
        $_SESSION['cw_speed']." ".l('wpm')."</strong>, ".l('effspeedlong')." = <strong>".
        $_SESSION['cw_eff']." ".l('wpm')."</strong>, ".l('tone')." =
        <strong>".($_SESSION['cw_tone_random'] ? (l('random'). " (500-900)") :
        $_SESSION['cw_tone'])." Hz</strong>, ".l('startdelay')." = ".$_SESSION['delay_start']." ".l('seconds')." &mdash; <a href=\"/cwsettings\">".l('change')."</a></p>";

}


function text2dotdash ($in) {

global $morsecode;

for ($i=0; $i < mb_strlen($in); $i++) {
	$out .= $code[mb_substr($in, $i, 1)]." ";
}

return $out;

}




function updatelocale () {
global $db;
$ul = mysqli_query($db,"SELECT `val` from `lcwo_config` where `key`='localeversion'");
$v = mysqli_fetch_array($ul);

if ($_SESSION['localeversion'] != $v['0']) {
	loadlocale($_SESSION['lang']);
}

}



function rand_init()
{
	list($usec, $sec) = explode(' ', microtime());
	$tmpseed = (float) $sec + ((float) $usec * 100000);
	srand($tmpseed);
}


function qrm() {
	return  "/* qrm */"; 
}


function selectnrbox ($min, $max, $step, $default, $name, $dest, $method, $group) {
		$url = "/$dest/";
		if ($group) {
			$url .= "group/$group/";
		}
		$url .= $name."/";
		echo "<form action='$url' method='POST'>\n";
		echo "<strong>".l('highestoverallaccuracy')."</strong>\n";
		echo "(&gt; ";
		echo "<select name='$name' size='1' style='font-size:10px'
				onchange=\"this.form.action=this.form.action+this.form.$name.value;this.form.submit();\">";
		for ($i = $min; $i < $max; $i += $step) {
			if ($i == $default) {
				echo "<option value='$i' selected>$i</option>\n";
			}
			else {
				echo "<option value='$i'>$i</option>\n";
			}
		}
		echo "</select> ";
		echo l('attempts').")";
		echo "</form>";
}

function microtime_float()
{
    list($usec, $sec) = explode(" ", microtime());
    return ((float)$usec + (float)$sec);
}


function graph($width, $height, 
				$ydata1, $yrange1, 
				$ydata2, $yrange2,
				$lesson, $filename,
				$desc) {

$im = imagecreate($width,$height);
$black = imagecolorallocate ($im, 0x00,0x00,0x00);
$white = imagecolorallocate ($im, 0xff,0xff,0xff);
$green = imagecolorallocate ($im, 0xa4,0xbf,0x12);
$red = imagecolorallocate ($im, 0xff,0x00,0x00);
$gray = imagecolorallocate ($im, 0xaa,0xaa,0xaa);
imagefilledrectangle($im,0,0,$width,$height,$white);
imagerectangle($im,0,0,$width-1,$height-1,$black);

imagestring($im, 3, 3, 1, "$desc[0] / ", $black);
imagestring($im, 3, 78,1,"$desc[1] / ", $green);
imagestring($im, 3, 140, 1, "Average", $red);
imagestring($im, 3, 3, 15, $desc[2], $black);
imagestring($im, 3, $width-30, 5, $desc[3], $black);

imagestring($im, 1, 5, $height-10, "Statistics for $_SESSION[username] at lcwo.net", $black);

imagestring($im, 3, $width-50, $height-16, "Attempt", $black);

$lspace = 25;
$tspace = 20;
$bspace = 25;
$rspace = 20;

# Adjust standard spacing (lrbt) in case we need to add
# labels on y-Axis beyond 999 (y1) or 99 (y2), otherwise
# the numbers would either be out of the image or intersect
# with the axis

$ifw = imagefontwidth(2); 

if (is_array($ydata1) && max($ydata1) >= 1000) {
	$lspace += $ifw*(mb_strlen(max($ydata1))-3); # space for 3 is already there
}

if (is_array($ydata2) && (max($ydata2) >= 100)) {
	$rspace += $ifw*(mb_strlen(max($ydata2))-2);
}

# calculate neccesary label distances etc.
# data points
$m = count($ydata1);
# x axis will have a maximum of $width / 50 labels.
$xwidth = $width - $lspace - $rspace;	# drawing area
$ywidth = $height - $tspace - $bspace;	# drawing area
$maxlabel = intval(($xwidth)/50);

if ($m > $maxlabel) {
	$labelstep = ceil($m / $maxlabel);
}
else {
	$labelstep = 1;
}

# draw 90% line below graph, if we have percentages
if ($yrange1[0] == 0 and $yrange1[1] == 100) {
imageline($im, $lspace-2, $height - $bspace - (($ywidth-$tspace)*0.9) , $width-$rspace, $height - $bspace - (($ywidth-$tspace)*0.9) , $gray);
}

# draw x labels and graph

$lastpt1 = array($lspace, $height - $bspace);
$lastpt2 = array($lspace, $height - $bspace);
$lastavg = array($lspace, $height - $bspace);
$lastlesson = 0;

$last5 = array($ydata1[1], $ydata1[1], $ydata1[1],
$ydata1[1], $ydata1[1]);

for ($j = 1; $j <= $m; $j++) {
	#for averaging
	if ($ydata1[$j] != 0) {					# ignore zero-attempts
		array_push($last5, $ydata1[$j]);
		array_shift($last5);
	}
	$avg_acc = $last5[0] + $last5[1] + $last5[2] + $last5[3] + $last5[4];
	$avg_acc /= 5;
	
	$xpos = $lspace + ((($j-1) / $labelstep) * ($xwidth / ($maxlabel+1))) ;
		if (!($j % $labelstep)) {			# print x label
			imagestring($im, 2, $xpos, $height-$bspace, "$j", $black);
		}

	# ydata1
		
	# normalize $ydata1 from min..max to 0..1 in $ypos (y = ax+b)
	$ypos = 1/($yrange1[1]-$yrange1[0]) * $ydata1[$j] -
								$yrange1[0]/($yrange1[1]-$yrange1[0]);
	# consider coordinates and maximum drawing area:

	$ypos = $height - $bspace - ($ywidth-$tspace)*$ypos;
	imageline($im, $lastpt1[0], $lastpt1[1], $xpos, $ypos, $black);
	$lastpt1 = array($xpos, $ypos);

	# ydata2

	if ($ydata2 != false) {
		# normalize $ydata2 from min..max to 0..1 in $ypos (y = ax+b)
		$ypos = 1/($yrange2[1]-$yrange2[0]) * $ydata2[$j] -
								$yrange2[0]/($yrange2[1]-$yrange2[0]);
		# consider coordinates and maximum drawing area:

		$ypos = $height - $bspace - ($ywidth-$tspace)*$ypos;
		imageline($im, $lastpt2[0], $lastpt2[1], $xpos, $ypos, $green);
		$lastpt2 = array($xpos, $ypos);
	}
	
	# Average Pixels
	$ypos = 1/($yrange1[1]-$yrange1[0]) * $avg_acc -
							$yrange1[0]/($yrange1[1]-$yrange1[0]);
	$ypos = $height - $bspace - (($ywidth-$tspace) * $ypos);
	if ($j > 1) {
		imageline($im, $lastavg[0], $lastavg[1], $xpos, $ypos, $red);
	}
	
	$lastavg = array($xpos, $ypos);
	if ($lastlesson != $lesson[$j]) {
		$lastlesson = $lesson[$j];
		imagestring($im, 5, $xpos, $tspace, "$lastlesson",
		$green);
	}

}

# Draw y axis etc. This is after the graph so it overwrites it in
# case they overlap. 


# y axis left
imageline($im, $lspace, $tspace, $lspace, $height-$bspace+5, $black);
imageline($im, $lspace, $tspace, $lspace-5, $tspace+5, $black);
imageline($im, $lspace, $tspace, $lspace+5, $tspace+5, $black);

if ($ydata2 != false) {	# right y axis
imageline($im, $width-$rspace, $tspace, $width-$rspace, $height-$bspace+5, $black);
imageline($im, $width-$rspace, $tspace, $width-$rspace-5, $tspace+5, $black);
imageline($im, $width-$rspace, $tspace, $width-$rspace+5, $tspace+5, $black);
}

# x axis
imageline($im, $lspace-5, $height-$bspace, $width-$rspace,
$height-$bspace, $black);
imageline($im, $width-$rspace, $height-$bspace, $width-$rspace-5,
$height-$bspace+5, $black);
imageline($im, $width-$rspace, $height-$bspace, $width-$rspace-5, 
$height-$bspace-5, $black);

# y-axis1 labels. $yrange1[0,1] = min, max
$point=0;
for ($j = $yrange1[0]; $j <= $yrange1[1]; $j += (($yrange1[1]-$yrange1[0])/4)) {
	$ypos = $height - $bspace - (($ywidth-$tspace) * $point/4);
	$point++;
	imagestring($im, 2, $lspace - 4 - $ifw*mb_strlen(intval($j)), $ypos - 7 , intval($j), $black);
	imageline($im, $lspace-2, $ypos, $lspace+2, $ypos, $black);
}

# y-axis2 labels. $yrange2[0,1] = min, max
if ($ydata2 != false) {
$point=0;
for ($j = $yrange2[0]; $j <= $yrange2[1]; $j += (($yrange2[1]-$yrange2[0])/4)) {
	$ypos = $height - $bspace - (($ywidth-$tspace) * $point/4);
	$point++;
	imagestring($im, 2, $width-$rspace+4, $ypos - 7 , intval($j), $black);
	imageline($im, $width-$rspace-2, $ypos, $width-$rspace+2, $ypos, $black);
}
}


imagegif($im, "img/$filename".imgurl($_SESSION['uid']).".gif");


}



function getcustomcharacters () {
    $arr = array();
    for ($i = 0; $i < mb_strlen($_SESSION['customcharacters']); $i++) {
        array_push($arr, mb_substr($_SESSION['customcharacters'], $i, 1));
    }
    return $arr;
}

function addquot ($a) {
	return preg_replace('/"/', '&quot;', $a);
}



function my_strtoupper ($s) {

	$s = mb_strtoupper($s);

	global $extracharlc;
	foreach ($extracharlc as $c => $k) {
		$s = preg_replace("/$c/", $k, $s);
	}

	/* fix commands like |f, |e and |w from uppercase again*/
	$s = preg_replace("/\|F/", "|f", $s);
	$s = preg_replace("/\|E/", "|e", $s);
	$s = preg_replace("/\|W/", "|w", $s);
	
	return $s;	

}

function isint ($i) {
	if (preg_match('/^[0-9]+$/',$i)) {
		return 1;
	}
	return 0;
}

function inrange ($x, $min, $max) {
	if (($x >= $min) && ($x <= $max)) {
		return true;
	}
	return false;
}


function f10spaces ($speed) {
	return "";
}

function uploadimage ($type) {
	if ($_FILES['file']['error']) {
		echo "An error occured during the upload!\n";
		return;
	}

	$size = getimagesize($_FILES['file']['tmp_name']);

	if ($size[2] != IMAGETYPE_JPEG) {
		echo "Error: Please upload a JPEG image!\n";
		return;
	}

	$newsize = array(120, 120);

	$uploadimg = imagecreatefromjpeg( $_FILES['file']['tmp_name']  );

	// resize needed?	
	if ($size[0] > 120 || $size[1] > 120) {
		if ($size[0] > $size[1]) {		// width > height -> 120x?
			$newsize[1] = round($size[1] * 120/$size[0],0);
		}
		else {
			$newsize[0] = round($size[0] * 120/$size[1],0);
		}
		$newimg = imagecreatetruecolor($newsize[0], $newsize[1]);
		imagecopyresampled($newimg, $uploadimg, 0, 0, 0, 0, $newsize[0], $newsize[1], $size[0], $size[1]);
	}		
	else {
		$newimg = $uploadimg;
	}


	if ($type == "profile") {
		$newfilename = "userimage".$_SESSION['uid'];
		$forward = "/profile/".$_SESSION['username'];
	}
	else if ($type == "group" && isint($_GET['group'])) {
		$newfilename = "groupimage".$_GET['group'];
		$forward = "/usergroups/".$_GET['group'];
	}
	else {
		echo "Error!";
		return;
	}

	if (imagejpeg($newimg, "img/$newfilename.jpg") == TRUE) {
		echo "Picture written... ";
?>
	<a href="/<? echo $forward ?>">OK</a>
		<script type="text/javascript">
		window.location.href = '<? echo $forward; ?>';
		</script>
<?
	}
	else {
		echo "Error. This should not happen. Mail ".ADMINMAIL." for help.\n";
	}

}


function is_admin_of($user, $group) {
    global $db;
    $isadmin = mysqli_query($db,"SELECT gid from lcwo_usergroups where gid='$group' and founder='$user'");
    return mysqli_fetch_row($isadmin);
}       
            
function is_member_of($user, $group) {
    global $db;
    $ismember = mysqli_query($db,"SELECT member from lcwo_groupmembers where gid='$group' and member='$user'"); 
    return mysqli_fetch_row($ismember);
}
  
function is_private_group($group) {
    global $db;
    $isprivate = mysqli_query($db,"SELECT private from lcwo_usergroups where gid='$group'");
    $bla = mysqli_fetch_row($isprivate);
    return $bla[0];
}

function get_group_name($group) {
global $db;
    $query = mysqli_query($db,"SELECT groupname from lcwo_usergroups where gid='$group'");
    $bla = mysqli_fetch_row($query);
    return $bla[0];
}

function is_subscribed_to($user, $group) {
global $db;
    $query = mysqli_query($db,"SELECT count(*) from lcwo_groupsubscribe where gid='$group' and member='$user';");
    $bla = mysqli_fetch_row($query);
    return $bla[0];
}


function stripcommands ($text) {
    $text = preg_replace('/\s+\|[fewFEWST][0-9]+/', ' ', $text);
    $text = preg_replace('/\s+/', ' ', $text);
    $text = preg_replace("/[ ]+/", ' ', $text);
    $text = preg_replace("/^ /", '', $text);
    $text = preg_replace("/ $/", '', $text);	
    $text = preg_replace("/^VVV( )?=( )?/", '', $text);
    $text = preg_replace("/( )?+$/", '', $text);
    return $text;	
}




function simplify ($lang, $text) {

	switch ($lang) {
		case 'fi':
		case 'de':
			$replace['ä'] = 'ae';
			$replace['ö'] = 'oe';
			$replace['ü'] = 'ue';
			$replace['Ä'] = 'ae';
			$replace['Ö'] = 'oe';
			$replace['Ü'] = 'ue';
			$replace['ß'] = 'ss';
			break;
		case 'fr':
			$replace['ô'] = 'o';
			$replace['ù'] = 'u';
			$replace['û'] = 'u';
			$replace['á'] = 'a';
			$replace['à'] = 'a';
			$replace['â'] = 'a';
			$replace['ç'] = 'c';
			$replace['é'] = 'e';
			$replace['è'] = 'e';
			$replace['ê'] = 'e';
			$replace['ë'] = 'e';
			$replace['ï'] = 'i';
			$replace['î'] = 'i';
			break;
		case 'es':
			$replace['à'] = 'a';
			$replace['á'] = 'a';
			$replace['é'] = 'e';
			$replace['è'] = 'e';
			$replace['í'] = 'i';
			$replace['ñ'] = 'n';
			$replace['ó'] = 'o';
			break;
		case 'pt':
			$replace['á'] = 'a';
			$replace['à'] = 'a';
			$replace['â'] = 'a';
			$replace['ã'] = 'a';
			$replace['ç'] = 'c';
			$replace['é'] = 'e';
			$replace['ê'] = 'e';
			$replace['í'] = 'i';
			$replace['ó'] = 'o';
			$replace['ô'] = 'o';
			$replace['õ'] = 'o';
			$replace['ú'] = 'u';
			$replace['ü'] = 'u';
			break;
		case 'pl':
			$replace['ą'] = 'a';
			$replace['ć'] = 'c';
			$replace['ę'] = 'e';
			$replace['ł'] = 'l';
			$replace['ń'] = 'n';
			$replace['ó'] = 'o';
			$replace['ś'] = 's';
			$replace['ź'] = 'z';
			$replace['ż'] = 'z';
			break;
		default:
			$replace['a'] = 'a';
			$replace["'"] = '';
	}

	foreach ($replace as $a => $b) {
		$text = preg_replace("/$a/", "$b", $text);
	}

	return $text;
}

/* Word training: Get the languages and sets.
 * Return array:  */
function getavailablewordcollections() {
	global $db;

	$table = "lcwo_words";
		
	$query = mysqli_query($db,"SELECT distinct lang, collid, collection from $table order by lang");

	if (!$query) {
		echo "Error: ".mysqli_error($db);
		return;
	}

	$wordlangs = array();
	
	$langnames["cw"] = l("cwabbreviations");
	while ($tmp = mysqli_fetch_row($query)) {
		array_push($wordlangs, $tmp[0]."~".$tmp[1]."~".$tmp[2]);
	}

	return $wordlangs;
}



function gettextsbylanguage ($type, $lang, $maxlen, $count, $simplify, $lesson){

    switch ($type) {
    case 'plaintext':
        return gettextsbylanguage1($type, $lang, $maxlen, $count, $simplify, $lesson);
        break;
    case 'words':
        # $lang is an array in the form "de0"  "de1"  "it0"  
        # (languages+collections)

        # we will generate a word list of length ceil($count/count(lang)) for each
        # language, shuffle the result, and then (if needed) cut the list to $count.

        $words = Array();
        foreach ($lang as $ltmp) {
            $t = gettextsbylanguage1($type, $ltmp, $maxlen, ceil($count/count($lang)), $simplify, $lesson);
            $words = array_merge($words, $t);
        }
        shuffle($words);
        $words = array_slice($words, 0, $count);
        return $words;
    }

}


/* get texts for word or plain text training for *one* language/collection */
function gettextsbylanguage1 ($type, $lang, $maxlen, $count, $simplify, $lesson){
	global $db;
	if ($maxlen < 2) {
		$maxlen = 2;
	}

	switch ($type) {
		case "words":
			$table = "lcwo_words";
			$item = "word";
			# $lang looks like "de0" "de1" "it0"  
			# (language+collection)
			$mylang = mb_substr($lang, 0, 2);
			$coll   = mb_substr($lang, 2, 1);
			$querystring =  "SELECT ID from $table where (`lang` = '$mylang' and `collid`='$coll') and length($item) <= $maxlen and lesson <= $lesson";
			break;
		case "plaintext":
			$table = "lcwo_plaintext";
			$item = "text";
			$mylang = $lang;
			/* Find texts */
			$querystring = "SELECT ID from $table where lang='$mylang' and length($item) <= $maxlen and lesson <= $lesson";
			break;
		default:
			echo "Fail in gettextsbylanguage()";
			exit();
	}

	$query = mysqli_query($db,$querystring);
	if (!$query) {
		echo "Error! ".mysqli_error($db);
		return;
	}
		

	$valid = array();
	while ($tmp = mysqli_fetch_row($query)) {
		array_push($valid, $tmp[0]);
	}

	if (count($valid) == 0) {
			echo "/* No records found with current parameters! */";
			return;
	}
	
	/* randomize */
	shuffle($valid);
 
	/* select max. $count words; might be less if not enough
	 * valid IDs were returned. */
	$selected = array();
	for ($i=0; $i < ((count($valid) >= $count) ? $count : count($valid)); $i++) {
		$selected[$i] = $valid[$i]; 
	}

	$selectedstring = implode($selected, ', ');	
	
	$query = mysqli_query($db,"SELECT $item, lang from $table where ID in ($selectedstring);");

	if (!$query) {
		echo "Error: ".mysqli_error();
		return;
	}
	
	$words = array();
	while ($tmp = mysqli_fetch_row($query)) {
		$word = mb_strtolower($tmp[0]);

        # replace HTML entities with their respective
        # representations in Latin1: &#252; => ü
        # *LEGACY* #UTF8
        $word= preg_replace_callback( '/&#(\d+);/', function ($m) { return mb_chr($m[1]); }, $word); 

		if ($simplify) {
			$word = simplify($tmp[1], $word);
		}
		array_push($words, $word);
	}

	/* enough words available? push random duplicates into array*/
	while (count($words) < $count) {
			array_push($words, $words[rand(0, count($words)-1)]);
	}
	
	shuffle($words);

	return $words;
}


# Calculate speed in REAL letters / minute from a text and PARIS speeds
function realspeed($text, $wpm, $wpmeff) {
	global $morsecode;

	$text = stripcommands($text);

	if ($wpmeff > $wpm or $wpmeff == 0) {
		$wpmeff = $wpm;
	}

	$dot_sec = 1.2 / $wpm;
	$fdot_sec  = 1.2 / $wpmeff;
	// stretch all pauses by this magic formula (fitted to a measured
	// set :) to get a good match. One day I will do the proper math!
	$stretch = (2.5 - 1.5/(pow(($wpm / $wpmeff),1.25)));
	$fdot_sec *= $stretch;
	$letterspace = 3 * $fdot_sec;
	$wordspace = 7 * $fdot_sec - $letterspace;

	$length = 0;
	$characters = 0;
	for ($i = 0; $i < mb_strlen($text); $i++) {
		if (mb_substr($text, $i, 1) == " ") {
				$length += $wordspace;
				continue; 
		}
		$characters++;
		$char = $morsecode[mb_substr($text, $i, 1)];
		for ($j = 0; $j < mb_strlen($char); $j++) {
			if (mb_substr($char, $j, 1) == ".") {
				$length += $dot_sec;
			}
			elseif (mb_substr($char, $j, 1) == "-") {
				$length += 3*$dot_sec;
			}
            if ($j < mb_strlen($char) - 1) {
    			$length += $dot_sec;	# intersymbol space
            }
		}
		$length += $letterspace;
	}

	$length -= $letterspace;		# remove space at the end

	$realspeed_cpm = 60*$characters/$length;
	$realspeed_wpm = 12*$characters/$length;

	return array(round($realspeed_cpm,1), round($realspeed_wpm,1), round($length,1), $characters, $length);
}


function bb2html ($text) {
    $text = preg_replace('#\[b\]([^\[]+)\[/b\]#',"<b>$1</b>",$text);
    $text = preg_replace('#\[i\]([^\[]+)\[/i\]#',"<i>$1</i>",$text);
    $text = preg_replace('#\[s\]([^\[]+)\[/s\]#',"<s>$1</s>",$text);
    $text = preg_replace('#\[quote=([a-zA-Z0-9]+)\]([^\[]+)\[/quote\]#',"<div class=\"quoted\"><strong>$1</strong>:<br> $2</div>",$text);

    $text = preg_replace_callback('#\[cw((\s+[a-z]+=[0-9]+)*)\]([^\[]+)\[/cw\]#',
        function ($m) {
            $params = Array();
            $params['speed'] = 20;
            $params['eff'] = 20;
            $params['ews'] = 0;
            $params['freq'] = 600;

            if ($m[1]) {	# extra parameters
                $arr = explode(' ', $m[1]);
                foreach ($arr as $p) {
                    if (preg_match('/([a-z]+)=([0-9]+)/', $p, $matches)) {
                        $params[$matches[1]] = $matches[2];
                        # if we only specify speed, also make it effective speed
                        # if eff speed is specified later, we will overwrite this
                        if ($matches[1] == "speed") {
                            $params['eff'] = $matches[2];
                        }

                    }
                }
            }

            $text = strip_tags($m[count($m) - 1]);
            $params['text'] = $text;

            $id = rand(1, 1000000);

            $vvv = $_SESSION['vvv'];
            $_SESSION['vvv'] = 0;
            return player($text, PL_JSCWLIB, $params['speed'], $params['eff'], 0 , $id, 'return', 1);
            $_SESSION['vvv'] = $vvv; # :-/
            

       }
    , $text);

    return $text;	
}


function toURLpath($foo) {
    $foo = preg_replace('/\s+/', "-", $foo);
    $foo = preg_replace('/&#[0-9]+(;)?/', "", $foo);
    $foo = preg_replace('/[^0-9a-zA-Z-]/', "", $foo);
    $foo = preg_replace('/[-]+$/', "", $foo);
    if (mb_strlen($foo)) {
        return "/".$foo;
    }
    else return "";
}


function privmsgcount () {
    global $db;
	if (!$_SESSION['uid'] or $_SESSION['uid'] == TESTUSER) {
		return "";
	}
	else {
		$query = mysqli_query($db,"SELECT count(*) from lcwo_pmsg where touid='".$_SESSION['uid']."' and `read`=0;");
		if ($query) {
			$k = mysqli_fetch_row($query);
			if ($k[0]) {
				return "(".$k[0].")";
			}
		}
	}
}

function sqlerror ($i) {
global $db;
	if (!$i) {
		echo "Error: ".mysqli_error($db);
		return TRUE;
	}
	else {
		return FALSE;
	}
}



/* random group length, 2 to 7, but distributed
 *
 * 2 ==    1 2
 * 3 ===   3 4 5
 * 4 ====  6 7 8 9
 * 5 ====  10 11 12 13
 * 6 ===   14 15 16
 * 7 ==    17 18
 */

function weightedrand1 () {
	$k = intval(rand(1,18));

	if ($k < 3) {
			return 2;
	}	
	elseif ($k < 6) {
			return 3;
	}
	elseif ($k < 10) {
			return 4;
	}
	elseif ($k < 14) {
			return 5;
	}
	elseif ($k < 17) {
			return 6;
	}
	return 7;
}


/* weightedrand2 for letters in the lessons 
 *
 * linear between 0 .. $lesson
 *
 *
 * */

function weightedrand2 ($lesson) {

	if ($lesson <= 9) {
			return intval(rand(0,$lesson));
	}

	$lesson++;

	do {
		$val = sqrt(mt_rand(0, ($lesson*1.5)*($lesson*1.5)));
		$val -= $lesson * 0.5;
	} while ($val < 0);

	$val = intval($val);

    if ($val > ($lesson-1)) {
            $val = ($lesson-1);
    }

	return $val;

}

function imgurl($uid) {
    return md5($uid.SALT_IMG_URL.$uid);
}

function delete_user($id) {
    global $db;

	$query = mysqli_query($db,"update lcwo_users set password='no', username='[deleted]', name = '', location = '', email='', koch_lesson=1, profileaboutme='' where id=\"$id\";");

	if ($query) {
		echo "Change user table: OK<br>";
	}
	else {
		echo "Error: ".mysqli_error($db);
	}
	
	echo "Callsign results: ";
	$query = mysqli_query($db,"delete from lcwo_callsignsresults where uid=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }
	
	echo "Group members: ";
	$query = mysqli_query($db,"delete from lcwo_groupmembers where member=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }

	echo "Group Requests: ";
	$query = mysqli_query($db,"delete from lcwo_grouprequests where member=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }


	echo "Group Results: ";
	$query = mysqli_query($db,"delete from lcwo_groupsresults where uid=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }

	echo "Lesson results: ";
	$query = mysqli_query($db,"delete from lcwo_lessonresults where uid=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }
	
	echo "MM results: ";
	$query = mysqli_query($db,"delete from lcwo_mmstatus where uid=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }
	
	echo "Plain text results: ";
	$query = mysqli_query($db,"delete from lcwo_plaintextresults where uid=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }
	
	echo "QTC results: ";
	$query = mysqli_query($db,"delete from lcwo_qtcresults where uid=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }
	
#	echo "snr tests: ";
#	$query = mysqli_query($db,"delete from lcwo_snrtests where uid=\"$id\";");
#	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
#	else { echo "Error: ".mysqli_error($db); }
	
	echo "Words results: ";
	$query = mysqli_query($db,"delete from lcwo_wordsresults where uid=\"$id\";");
	if ($query) { echo "OK (".mysqli_affected_rows($db).")<br>"; }
	else { echo "Error: ".mysqli_error($db); }
	
}

function delete_user_url() {                                                    
    global $db;
    $q = mysqli_query($db,"select password from lcwo_users where id=$_SESSION[uid];");                                                                   
    $o = mysqli_fetch_object($q);
    $pwhash = md5($o->password);                                    
    $mailtext = "unset HISTFILE\n";
    $mailtext .= "# deleting user: ".$_SESSION['username']." - ".$_SESSION['uid']." - ".getenv("REMOTE_ADDR");
    $mailtext .= "\n\ncurl \"".BASEURL."/adm/delete-user?u=".$_SESSION['uid']."&h=$pwhash\"\n";
    return $mailtext;
}

# Return the CGI base-URL (e.g. http://cgi2.lcwo.net/cgi-bin/)
function CGIURL() {
    global $cgiserver;
    $proto = "https://";
    if (!$_SERVER['HTTPS']) {   # Docker etc.
        $proto = "http://";
    }
    return $proto.$cgiserver."/cgi-bin/";
}


# Check if IP address is in the "untrusted" list, as
# defined in definitions.php
# (If so, the user needs to solve a captcha) 
function is_untrusted_ip($ip) {
        global $untrustedips;
        foreach ($untrustedips as $i) {
                if (preg_match('/'.$i.'/', $ip)) {
                        return true;
                }
        }
        return false;
}


function is_deleted_user() {
	global $db;
	$q = mysqli_query($db,"select username from lcwo_users where id='".$_SESSION['uid']."'");
	$o = mysqli_fetch_object($q);
	if ($o->username == "[deleted]") {
		mysqli_query($db,"delete from lcwo_online where `UID`=".$_SESSION['uid']);
		$msg = "LCWO: Deleted user from ".$_SERVER['REMOTE_ADDR']." \n";
		$msg .= $_SESSION['username']."\n";
		$msg .= $_SERVER['HTTP_REFERER']."  \n";
		mail(ADMINMAIL, "Deleted user log out LCWO: ".$_SERVER['HTTP_REFERER'], $msg);
		session_destroy();
	}
	else {
		return 0;
	}
}



?>
